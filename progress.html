<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Progress</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <main class="container">
    <header class="card">
      <h1>Progress</h1>
      <p class="muted">Local progress stored by Player Code. No accounts.</p>
      <div class="row wrap space">
        <div>
          <h2 id="player">Player: —</h2>
          <p class="muted" id="statsLine">—</p>
        </div>
        <div class="row wrap">
          <button class="btn" id="exportBtn">Export</button>
          <label class="btn btn-secondary" for="importFile" style="cursor:pointer;">Import</label>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
          <button class="btn btn-danger" id="resetBtn">Reset</button>
        </div>
      </div>
    </header>

    <section class="card">
      <h2>Advanced Summary</h2>
      <div id="advancedSummary" class="list"></div>
    </section>

    <section class="card">
      <h2>Recent Sessions</h2>
      <div id="list" class="list"></div>
    </section>
  </main>

  <script src="assets/app.js"></script>
  <script src="assets/storage.js"></script>
  <script>
    const playerEl = document.getElementById('player');
    const statsLine = document.getElementById('statsLine');
    const list = document.getElementById('list');
    const advancedSummary = document.getElementById('advancedSummary');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const resetBtn = document.getElementById('resetBtn');

    const code = MQ.getPlayerCode() || 'GUEST';
    playerEl.textContent = `Player: ${code}`;

    function render() {
      const data = MQ.getProgress();
      const sessions = data.sessions || [];
      const streak = MQ.getStreakDays(data.lastPracticeDate);
      const best = sessions.reduce((m, s) => Math.max(m, s.scorePct || 0), 0);

      statsLine.textContent = `Sessions: ${sessions.length} • Best score: ${best}% • Streak: ${streak} day(s)`;

      // Recent sessions (elementary + advanced)
      list.innerHTML = '';
      if (sessions.length === 0) {
        list.innerHTML = `<p class="muted">No sessions yet. Do a mission first.</p>`;
      } else {
        sessions.slice().reverse().slice(0, 12).forEach(s => {
          const when = new Date(s.timestamp);
          const row = document.createElement('div');
          row.className = 'list-item';
          row.innerHTML = `
            <div class="strong">${s.mode}</div>
            <div class="muted small">${when.toLocaleString()}</div>
            <div class="pill">${s.correct}/${s.total} • ${s.scorePct}%</div>
          `;
          list.appendChild(row);
        });
      }

      // Advanced summary by topic
      advancedSummary.innerHTML = '';
      const advStats = AdvancedStore.getBestScoresByTopic();
      if (Object.keys(advStats).length === 0) {
        advancedSummary.innerHTML = `<p class="muted">No advanced sessions yet.</p>`;
      } else {
        for (const key of Object.keys(advStats)) {
          const entry = advStats[key];
          const node = document.createElement('div');
          node.className = 'list-item';
          node.innerHTML = `
            <div class="strong">${entry.topic} • ${entry.level}</div>
            <div class="muted small">Best: ${entry.best}% • Played: ${entry.count} time(s)</div>
            <div class="pill">Streak: ${entry.streak}</div>
          `;
          advancedSummary.appendChild(node);
        }
      }
    }

    exportBtn.addEventListener('click', () => {
      const blob = MQ.exportProgressBlob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `math-quest-progress-${(MQ.getPlayerCode() || 'GUEST').toLowerCase()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const ok = MQ.importProgress(text);
      if (!ok) alert('Import failed. File not recognized.');
      render();
      importFile.value = '';
    });

    resetBtn.addEventListener('click', () => {
      if (!confirm('Reset local progress on this device?')) return;
      MQ.resetProgress();
      render();
    });

    render();
  </script>
</body>
</html>
