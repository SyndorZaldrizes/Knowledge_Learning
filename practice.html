<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Practice Mission</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <main class="container">
    <header class="card">
      <h1 id="title">Practice Mission</h1>
      <p id="subtitle" class="muted"></p>
      <div class="row wrap">
        <a class="btn btn-secondary" href="index.html">Home</a>
        <a class="btn btn-secondary" href="progress.html">Progress</a>
      </div>
    </header>

    <section class="card">
      <div class="row space">
        <div class="pill" id="counter">Question 1 / 10</div>
        <div class="row wrap">
          <div class="pill" id="timerPill" style="display:none;">Time left: 60s</div>
          <div class="pill" id="playerPill">Player: —</div>
        </div>
      </div>

      <div class="question" id="question">—</div>

      <div class="row">
        <input id="answer" class="input" inputmode="numeric" placeholder="Type answer" />
        <button id="submit" class="btn">Submit</button>
      </div>

      <p id="feedback" class="feedback"></p>
    </section>

    <section class="card" id="results" style="display:none;">
      <h2>Mission Complete</h2>
      <p id="scoreLine" class="muted"></p>
      <div id="review"></div>
      <div class="row wrap">
        <a class="btn" id="retry" href="#">Retry</a>
        <a class="btn btn-secondary" href="index.html">Home</a>
        <a class="btn btn-secondary" href="progress.html">Progress</a>
      </div>
    </section>
  </main>

  <script src="assets/app.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const mode = params.get('mode') || 'mult';
    const max = Number(params.get('max') || 10);
    const level = params.get('level') || 'basic';
    const timed = params.get('timed') === '1';
    const tParam = Number(params.get('t'));
    const nParam = params.get('n');
    let TOTAL = 10;
    if (nParam) {
      const n = Number(nParam);
      if (!Number.isNaN(n)) {
        TOTAL = Math.max(10, Math.min(100, n)); // Clamp to [10, 100]
      }
    }

    const title = document.getElementById('title');
    const subtitle = document.getElementById('subtitle');
    const counter = document.getElementById('counter');
    const qEl = document.getElementById('question');
    const ansEl = document.getElementById('answer');
    const submitBtn = document.getElementById('submit');
    const feedback = document.getElementById('feedback');
    const results = document.getElementById('results');
    const scoreLine = document.getElementById('scoreLine');
    const review = document.getElementById('review');
    const playerPill = document.getElementById('playerPill');
    const retry = document.getElementById('retry');
    const timerPill = document.getElementById('timerPill');

    const player = MQ.getPlayerCode() || 'GUEST';
    playerPill.textContent = `Player: ${player}`;

    const maxFactor = Number.isFinite(max) && max > 0 ? Math.floor(max) : 10;
    const isHard = level === 'hard';
    const modeLabel = (() => {
      if (mode === 'mult') return isHard ? 'Multiplication Hard' : `Multiplication (0–${maxFactor})`;
      if (mode === 'div') return isHard ? 'Division Hard' : `Division (0–${maxFactor})`;
      if (mode === 'mixed') return 'Timed Quiz • Mixed';
      return 'Practice';
    })();
    title.textContent = modeLabel;
    const timeLimit = Number.isNaN(tParam) ? 60 : Math.round(tParam);
    const clampedTime = Math.max(30, Math.min(300, timeLimit));
    subtitle.textContent = timed
      ? `Answer as many as you can in ${clampedTime}s.`
      : `Answer ${TOTAL} questions. Fast and focused.`;

    const retryParams = new URLSearchParams();
    retryParams.set('mode', mode);
    retryParams.set('max', String(maxFactor));
    retryParams.set('n', String(TOTAL));
    if (level) retryParams.set('level', level);
    if (timed) {
      retryParams.set('timed', '1');
      retryParams.set('t', String(clampedTime));
    }
    retry.href = `practice.html?${retryParams.toString()}`;

    let i = 0;
    let correct = 0;
    let current = null;
    const missed = [];
    let finished = false;
    let timerId = null;
    let timeLeft = clampedTime;

    if (timed) {
      timerPill.style.display = 'inline-flex';
      timerPill.textContent = `Time left: ${timeLeft}s`;
      timerId = setInterval(() => {
        timeLeft--;
        timerPill.textContent = `Time left: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerId);
          finish(true);
        }
      }, 1000);
    }

    function newQuestion() {
      feedback.textContent = '';
      ansEl.value = '';
      ansEl.focus();
      counter.textContent = `Question ${i + 1} / ${TOTAL}`;

      const makeMultBasic = () => {
        const a = MQ.randInt(0, maxFactor);
        const b = MQ.randInt(0, maxFactor);
        return { a, b, answer: a * b, text: `${a} × ${b} = ?`, promptText: `${a} × ${b}` };
      };

      const makeMultHard = () => {
        const a = MQ.randInt(10, 99);
        const bMax = Math.max(2, maxFactor);
        const b = MQ.randInt(2, bMax);
        return { a, b, answer: a * b, text: `${a} × ${b} = ?`, promptText: `${a} × ${b}` };
      };

      const makeDivBasic = () => {
        const divisor = MQ.randInt(1, maxFactor);
        const quotient = MQ.randInt(0, maxFactor);
        const dividend = divisor * quotient;
        return {
          a: dividend,
          b: divisor,
          answer: quotient,
          text: `${dividend} ÷ ${divisor} = ?`,
          promptText: `${dividend} ÷ ${divisor}`
        };
      };

      const makeDivHard = () => {
        const divisor = MQ.randInt(2, Math.min(12, Math.max(2, maxFactor)));
        const quotient = MQ.randInt(10, 99);
        const dividend = divisor * quotient;
        return {
          a: dividend,
          b: divisor,
          answer: quotient,
          text: `${dividend} ÷ ${divisor} = ?`,
          promptText: `${dividend} ÷ ${divisor}`
        };
      };

      if (mode === 'mult') {
        current = isHard ? makeMultHard() : makeMultBasic();
      } else if (mode === 'div') {
        current = isHard ? makeDivHard() : makeDivBasic();
      } else if (mode === 'mixed') {
        current = (Math.random() < 0.5) ? makeMultBasic() : makeDivBasic();
      } else {
        current = { a: 1, b: 1, answer: 1, text: `Coming soon` };
      }

      qEl.textContent = current.text;
    }

    function recordMiss(promptText, userAnswer, correctAnswer) {
      const idx = missed.findIndex(item => item.promptText === promptText);
      const entry = { promptText, userAnswer, correctAnswer };
      if (idx === -1) {
        missed.push(entry);
      } else {
        missed[idx] = entry;
      }
    }

    function renderReview() {
      review.innerHTML = '';
      const title = document.createElement('h3');
      title.textContent = 'Review Mistakes';
      review.appendChild(title);

      if (missed.length === 0) {
        const message = document.createElement('p');
        message.className = 'muted';
        message.textContent = 'Perfect mission. No mistakes.';
        review.appendChild(message);
        return;
      }

      const list = document.createElement('div');
      list.className = 'list';
      missed.forEach(item => {
        const row = document.createElement('div');
        row.className = 'list-item';
        const prompt = document.createElement('div');
        prompt.className = 'strong';
        prompt.textContent = item.promptText;
        const detail = document.createElement('div');
        detail.className = 'muted small';
        detail.textContent = `Your answer: ${item.userAnswer} • Correct: ${item.correctAnswer}`;
        row.appendChild(prompt);
        row.appendChild(detail);
        list.appendChild(row);
      });
      review.appendChild(list);
    }

    function finish(fromTimer = false) {
      if (finished) return;
      finished = true;
      if (timerId) clearInterval(timerId);
      const attempted = fromTimer ? i : TOTAL;
      const totalForScore = timed ? attempted : TOTAL;
      const scorePct = totalForScore ? Math.round((correct / totalForScore) * 100) : 0;
      const session = {
        mode: modeLabel,
        total: totalForScore,
        correct,
        scorePct,
        timestamp: new Date().toISOString()
      };

      MQ.recordSession(session);

      scoreLine.textContent = `Score: ${correct}/${totalForScore} (${scorePct}%)`;
      renderReview();
      results.style.display = 'block';
      submitBtn.disabled = true;
      ansEl.disabled = true;
    }

    function submit() {
      if (!current) return;

      const raw = ansEl.value.trim();
      const user = Number(raw);

      if (raw === '' || Number.isNaN(user)) {
        feedback.textContent = 'Enter a number.';
        feedback.className = 'feedback warn';
        return;
      }

      if (user === current.answer) {
        correct++;
        feedback.textContent = 'Correct ✅';
        feedback.className = 'feedback ok';
      } else {
        feedback.textContent = `Not quite. Correct answer: ${current.answer}`;
        feedback.className = 'feedback bad';
        recordMiss(current.promptText || current.text, raw, current.answer);
      }

      i++;
      if (i >= TOTAL) {
        finish(false);
      } else {
        setTimeout(newQuestion, 450);
      }
    }

    submitBtn.addEventListener('click', submit);
    ansEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submit();
    });

    newQuestion();
  </script>
</body>
</html>
